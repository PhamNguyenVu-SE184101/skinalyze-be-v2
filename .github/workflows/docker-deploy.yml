# GitHub Actions workflow for automatic deployment
name: ğŸš€ Deploy to Digital Ocean

on:
  push:
    branches:
      - main
      - be
  pull_request:
    branches:
      - main
      - be
  workflow_dispatch:

env:
  DEPLOY_PATH: /root/skinalyze-be-v2

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”” Discord notification - Deployment started
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: 'ğŸš€ Skinalyze Backend - Deployment Started'
          description: |
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            **ğŸ“¦ Repository:** Skinalyze Backend API
            **ğŸŒ Environment:** Production
            **ğŸŒ¿ Branch:** `${{ github.ref_name }}`
            **ğŸ’¬ Commit:** ${{ github.event.head_commit.message }}
            **ğŸ‘¤ Triggered By:** ${{ github.actor }}
            **â±ï¸ Started At:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            âš¡ Deployment process initiated...
          color: 0xFFA500
          username: Skinalyze Deploy Bot
          avatar_url: https://res.cloudinary.com/dh2sxkvuu/image/upload/v1761827397/tyrant_wpum0x.jpg

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ§ª Test SSH connection
        run: |
          ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "echo 'âœ… SSH connection successful'"

      - name: ğŸš€ Deploy to Digital Ocean
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          script: |
            echo "ğŸ“ Navigating to project directory..."
            cd /root/skinalyze-be-v2

            echo "ğŸ” Checking current state..."
            git status

            echo "ğŸ“¥ Force pulling latest code..."
            git fetch origin
            git clean -fd
            git reset --hard origin/${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            echo "âœ… Code updated to commit:"
            git log -1 --oneline

            echo "ğŸ” Checking Docker..."
            docker --version
            docker-compose --version

            echo "â¹ï¸  Stopping and removing existing containers..."
            docker-compose down --remove-orphans

            echo "ğŸ§¹ Removing old app image..."
            docker rmi skinalyze-app || true

            echo "ğŸ”¨ Building new app image (no cache)..."
            docker-compose build --no-cache --pull app

            echo "ğŸš€ Starting services..."
            docker-compose up -d

            echo "â³ Waiting for services to start..."
            sleep 20

            echo "ğŸ¥ Checking service health..."
            docker-compose ps

            echo "ğŸ“‹ Showing recent logs..."
            docker-compose logs --tail=50 app

            echo "âœ… Deployment complete!"

      - name: ğŸ¥ Health Check
        id: health_check
        run: |
          echo "â³ Waiting for application to be ready..."
          sleep 30

          # Health check vá»›i retry
          for i in {1..10}; do
            if ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "curl -f -k https://api.nhatlonh.id.vn/api/v1 || curl -f http://localhost:3000/api/v1"; then
              echo "âœ… Health check passed!"
              echo "health_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "â³ Attempt $i/10 failed, retrying in 10s..."
            sleep 10
          done

          echo "âš ï¸ Health check timeout - checking logs..."
          ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "cd /root/skinalyze-be-v2 && docker-compose -f docker-compose.yml logs --tail=100 app"
          echo "health_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: ğŸ“Š Get deployment info
        id: deployment_info
        if: always()
        run: |
          DEPLOY_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "deploy_time=$DEPLOY_TIME" >> $GITHUB_OUTPUT

          # Get container status
          CONTAINER_STATUS=$(ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "cd /root/skinalyze-be-v2 && docker-compose -f docker-compose.yml ps" || echo "Failed to get status")
          echo "Container Status:"
          echo "$CONTAINER_STATUS"

      - name: ğŸ‰ Discord notification - Deployment succeeded
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'Success'
          title: 'âœ… Skinalyze Backend - Deployment Successful!'
          description: |
            <@&1385529547281403966>

            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            **ğŸ“¦ Repository:** Skinalyze Backend API
            **ğŸŒ Environment:** Production
            **ğŸŒ¿ Branch:** `${{ github.ref_name }}`
            **ğŸ’¬ Commit:** ${{ github.event.head_commit.message }}
            **ğŸ‘¤ Deployed By:** ${{ github.actor }}
            **â±ï¸ Deploy Time:** ${{ steps.deployment_info.outputs.deploy_time }}
            **ğŸ¥ Health Check:** âœ… Passed
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**

            **ğŸ”— Quick Links:**
            â€¢ [View Commit](${{ github.event.head_commit.url }})
            â€¢ [API Documentation](https://api.nhatlonh.id.vn/api/docs)
            â€¢ [Health Check](https://api.nhatlonh.id.vn/health)
            â€¢ [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ğŸ‰ **All services are running smoothly!**
          color: 0x00FF00
          username: Skinalyze Deploy Bot
          avatar_url: https://res.cloudinary.com/dh2sxkvuu/image/upload/v1761827397/tyrant_wpum0x.jpg

      - name: âŒ Discord notification - Deployment failed
        uses: sarisia/actions-status-discord@v1
        if: failure()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'Failure'
          title: 'âŒ Skinalyze Backend - Deployment Failed!'
          description: |
            <@&1385529547281403966>

            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            **ğŸ“¦ Repository:** Skinalyze Backend API
            **ğŸŒ Environment:** Production
            **ğŸŒ¿ Branch:** `${{ github.ref_name }}`
            **ğŸ’¬ Commit:** ${{ github.event.head_commit.message }}
            **ğŸ‘¤ Triggered By:** ${{ github.actor }}
            **â±ï¸ Failed At:** ${{ steps.deployment_info.outputs.deploy_time }}
            **âŒ Status:** Deployment or health check failed
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**

            **ğŸ”— Troubleshooting Links:**
            â€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [View Error Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [View Commit](${{ github.event.head_commit.url }})

            âš ï¸ **Please check the logs and fix the issue!**
          color: 0xFF0000
          username: Skinalyze Deploy Bot
          avatar_url: https://res.cloudinary.com/dh2sxkvuu/image/upload/v1761827397/tyrant_wpum0x.jpg

      - name: ğŸ“ Get deployment logs
        if: failure()
        run: |
          echo "Getting logs from failed deployment..."
          ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "cd ${{ env.DEPLOY_PATH }} && docker-compose logs --tail=100"
